$nc.fn.upload=function(){function p(a,b){if(b.value){var c=g?b.files[0].type:"",d=g?b.files[0].name:b.value.substr(b.value.lastIndexOf("\\")+1),e=h(a),f=$nc(b).hide(),i=q(a,d);j(e)&&(f.prop("class","nc-upload-file-input").appendTo(i),f=$nc('<input class="nc-upload-input" type="file" name="'+b.name+'" multiple />').appendTo(e),r(f),k(e));i.hide().appendTo(a).slideDown(100).find(".nc-upload-file-custom-name input:text").focus();n(c)?(e=new FileReader,e.onload=function(a){l(i,c,d,a.target.result,!0)},
e.readAsDataURL(b.files[0])):l(i,c,d,null,!0)}}function u(a,b){var c=h(a),d="f_"+c.data("fieldName")+"_content"+(j(c)?"[]":""),e=c.data("maxFiles");$nc.each(b,function(b,i){if(e&&"0"!=e&&o(c)>=e)return!1;var s=i.type,g=i.name,h=q(a,g,"i"),j=new FileReader;j.onload=function(a){m(d,i.name+"/"+a.target.result,"nc-upload-file-content").appendTo(h);a=n(s)?a.target.result:null;l(h,s,g,a,!0)};j.readAsDataURL(i);h.hide().appendTo(a).slideDown(100)});k(c)}function q(a,b,c){var d=h(a),b=$nc('<div class="nc-upload-file"><div class="nc-upload-file-info"><span class="nc-upload-file-name">'+
b+'</span> <a href="#" class="nc-upload-file-remove" tabindex="-1">\u00d7</a></div></div>');if(j(d)){var e=d.data("fieldId"),f=o(a);d.data("customName")&&(d=$nc("<input />",{type:"text",name:"f_"+d.data("fieldName")+"_name[]",placeholder:d.data("customNameCaption"),value:""}),$nc('<div class="nc-upload-file-custom-name" />').append(d).appendTo(b));b.append(m("priority_multifile["+e+"][]",-1,"nc-upload-file-priority"),m("multifile_new_priority["+e+"][]",f,"nc-upload-file-priority"),m("multifile_upload_type["+
e+"][]",c||"f","nc-upload-file-upload-type"))}b.appendTo(a);t(b);return b}function l(a,b,c,d,e){var f=$nc("<div />").addClass("nc-upload-file-preview nc-upload-file-drag-handle");(b=n(b))&&g?(f.addClass("nc-upload-file-preview-image").append('<img src="'+d+'" />'),h(a).addClass("nc-upload-with-preview")):(d=c.lastIndexOf("."),f.addClass("nc-upload-file-preview-other"),0<d&&f.append('<span class="nc-upload-file-extension">'+c.substr(d+1)+"</span>"));a.prepend('<div class="nc-upload-file-drag-icon nc-upload-file-drag-handle"><i class="nc-icon nc--file-text"></i></div>',
f);if((b||a.closest(".nc-upload-with-preview").length)&&g)e?f.slideDown(100):f.show();return f}function n(a){return a?a.match(/^image\b/):!1}function j(a){return a.hasClass("nc-upload-multifile")}function h(a){return a.closest(".nc-upload")}function o(a){return a.find(".nc-upload-file:visible").length}function k(a){var b=a.data("maxFiles");if(b&&j(a)){var c=a.find(".nc-upload-input");o(a)>=b?c.hide():c.show()}}function r(a){g||a[0].attachEvent("onpropertychange",function(){var a=window.event.srcElement;
if("value"==window.event.propertyName&&a.value.length){var c=$nc(a);c.is(":visible")&&p(h(c).find(".nc-upload-files"),a)}})}function m(a,b,c){return $nc("<input />",{type:"hidden",name:a,value:b,"class":c})}function v(a){a.preventDefault();a.stopPropagation();var b=$nc(a.target).closest(".nc-upload-file");b.find(".nc-upload-file-remove-hidden").val("1");b.find(".nc-upload-file-remove-checkbox").prop("checked","checked");b.slideUp(100,function(){b.find(".nc-upload-file-input, .nc-upload-file-content, .nc-upload-file-upload-type, .nc-upload-file-priority, .nc-upload-file-custom-name").remove();
var a=h(b);a.hasClass("nc-upload-with-preview")&&0==a.find(".nc-upload-file:visible .nc-upload-file-preview-image").length&&a.removeClass("nc-upload-with-preview");var d=a.find(".nc-upload-input"),e=d.clone().val("").show();d.replaceWith(e);d=$nc.Event("change");d.target=e[0];$nc(document).trigger(d);k(a)});return!1}function t(a){a.find(".nc-upload-file-remove").off("click.nc-upload").on("click.nc-upload",v)}var g="FileReader"in window;return this.each(function(){var a=$nc(this);if(!a.hasClass("nc-upload-applied")){a.addClass("nc-upload-applied");
var b=j(a),c=a.find(".nc-upload-files"),d=c.find(".nc-upload-file");0<d.length&&!b&&a.find(".nc-upload-input").hide();d.each(function(){var a=$nc(this),b=a.data("type"),c=a.find(".nc-upload-file-name"),d=c.html(),c=c.prop("href");l(a,b,d,c,!1)});setTimeout(function(){k(a)},10);a.on("change",".nc-upload-input",function(){if(this.files&&this.files.length)1<this.files.length&&g?(u(c,this.files),this.value=null):p(c,this)});g||r(a.find(".nc-upload-input"));t(c);if(b){var e;c.on("mousedown",".nc-upload-file-drag-handle",
function(a){a.preventDefault();c.addClass("nc--dragging");e=$nc(this).closest(".nc-upload-file").addClass("nc--dragged");$nc(window).on("mouseup.nc-upload",function(){c.removeClass("nc--dragging");e.removeClass("nc--dragged");c.find(".nc-upload-file").each(function(a){$nc(this).find(".nc-upload-file-priority[name^=multifile_new_priority]").val(a)});$nc(window).off("mouseup.nc-upload");e=null})});c.on("mousemove",".nc-upload-file",function(a){var b=$nc(this);if(e&&!b.hasClass("nc--dragged")){if("none"==
b.css("float"))var a=a.pageY-b.offset().top,c=b.height();else a=a.pageX-b.offset().left,c=b.width();(a=a<c/2)?e.insertBefore(b):e.insertAfter(b)}})}}})};$nc(document).on("apply-upload",function(){$nc(".nc-upload").upload()});
